# 影片轉換器優化方案

## 一、現況分析

### 1.1 現有程式碼結構
- **ReSizeVideoIntel.py**: 簡單的 OpenCV 影片縮放腳本（CPU 處理）
- **video_convert_cuda.py**: CUDA 硬體加速版本（GUI）
- **video_convert_cuda_upgrade.py**: CUDA 升級版本（改進超時處理）
- **video_convert_intel.py**: Intel QSV 硬體加速版本（含軟體編碼備援）

### 1.2 主要問題

#### 程式碼重複
- 多個檔案包含相似的邏輯（序列號管理、檔案選擇、轉換流程）
- 缺乏統一的模組化設計

#### 錯誤處理不一致
- `video_convert_cuda.py` 使用簡單的 try-except
- `video_convert_cuda_upgrade.py` 有較好的超時處理
- `video_convert_intel.py` 有硬體加速失敗時的備援機制

#### 硬體加速選擇
- 各版本針對不同硬體（CUDA、Intel QSV）
- 缺少自動偵測可用硬體加速的功能
- 無法動態切換編碼器

#### 功能限制
- 缺少進度條顯示
- 沒有轉換統計資訊（成功率、總時間等）
- 序列號管理可能出現競爭條件
- 缺少暫停/恢復功能
- 無法儲存/載入轉換設定

#### UI/UX 問題
- 使用舊版 Tkinter，介面較為簡陋
- 缺少現代化的視覺回饋
- 日誌顯示可能造成效能問題（大量訊息時）

## 二、優化方案

### 2.1 架構重構

#### 建議結構
```
video_converter/
├── core/
│   ├── __init__.py
│   ├── converter.py          # 核心轉換邏輯
│   ├── encoder_detector.py   # 硬體加速偵測
│   ├── sequence_manager.py   # 序列號管理（執行緒安全）
│   └── config.py             # 配置管理
├── ui/
│   ├── __init__.py
│   ├── main_window.py        # 主視窗
│   ├── progress_widget.py    # 進度顯示元件
│   └── log_widget.py         # 日誌顯示元件
├── utils/
│   ├── __init__.py
│   ├── logger.py             # 日誌工具
│   └── file_utils.py         # 檔案工具
└── main.py                   # 應用程式入口
```

### 2.2 核心功能優化

#### 2.2.1 硬體加速自動偵測
```python
# encoder_detector.py 概念
class EncoderDetector:
    def detect_available_encoders(self):
        """自動偵測可用的硬體加速編碼器"""
        encoders = []
        # 檢測 CUDA/NVENC
        if self._check_nvenc():
            encoders.append('h264_nvenc')
        # 檢測 Intel QSV
        if self._check_qsv():
            encoders.append('h264_qsv')
        # 檢測 AMD VCE
        if self._check_vce():
            encoders.append('h264_amf')
        # 軟體編碼作為備援
        encoders.append('libx264')
        return encoders
```

#### 2.2.2 執行緒安全的序列號管理
```python
# sequence_manager.py 概念
import threading
import json

class SequenceManager:
    def __init__(self, sequence_file="sequence_number.txt"):
        self.sequence_file = sequence_file
        self.lock = threading.Lock()
        self.current_sequence = self._load_sequence()
    
    def get_next(self):
        with self.lock:
            seq = self.current_sequence
            self.current_sequence += 1
            self._save_sequence()
            return seq
```

#### 2.2.3 統一的轉換器介面
```python
# converter.py 概念
class VideoConverter:
    def __init__(self, encoder='auto', width=1280, height=720, bitrate='1000k'):
        self.encoder = encoder
        self.width = width
        self.height = height
        self.bitrate = bitrate
        self.encoder_detector = EncoderDetector()
    
    def convert(self, input_path, output_path, progress_callback=None):
        """統一的轉換介面，支援進度回調"""
        # 自動選擇最佳編碼器
        # 執行轉換
        # 回報進度
        pass
```

### 2.3 UI/UX 改進

#### 2.3.1 現代化 UI 元件
- 使用 `ttk`（Tkinter 主題元件）替代標準元件
- 添加進度條（`ttk.Progressbar`）
- 添加檔案列表顯示（`ttk.Treeview`）
- 添加轉換統計面板

#### 2.3.2 進度顯示
- 整體進度（已完成檔案數/總檔案數）
- 單檔進度（解析 FFmpeg 輸出中的 frame 資訊）
- 預估剩餘時間
- 轉換速度（FPS）

#### 2.3.3 日誌優化
- 限制日誌緩衝區大小（避免記憶體問題）
- 添加日誌等級過濾（INFO、WARNING、ERROR）
- 支援匯出日誌檔案
- 使用虛擬化列表（大量日誌時）

### 2.4 功能增強

#### 2.4.1 設定管理
- 儲存/載入轉換設定（JSON 格式）
- 預設設定檔
- 多組設定檔切換

#### 2.4.2 批次處理改進
- 支援拖放檔案
- 支援資料夾批次處理
- 檔案過濾（大小、格式、解析度）
- 轉換前預覽

#### 2.4.3 錯誤處理與恢復
- 詳細的錯誤日誌
- 失敗檔案重試機制
- 轉換中斷後可恢復（檢查點機制）
- 錯誤報告匯出

#### 2.4.4 效能優化
- 多執行緒批次處理（可配置並發數）
- 智慧執行緒數調整（根據 CPU/GPU 負載）
- 記憶體使用優化
- FFmpeg 參數調優

### 2.5 程式碼品質

#### 2.5.1 程式碼規範
- 遵循 PEP 8 規範
- 添加型別提示（Type Hints）
- 完整的文件字串（Docstrings）

#### 2.5.2 測試
- 單元測試（核心轉換邏輯）
- 整合測試（完整流程）
- 錯誤情況測試

#### 2.5.3 依賴管理
- 建立 `requirements.txt`
- 版本鎖定
- 可選依賴（硬體加速相關）

## 三、實作優先順序

### 第一階段（核心重構）
1. ✅ 建立模組化架構
2. ✅ 統一的轉換器介面
3. ✅ 執行緒安全的序列號管理
4. ✅ 硬體加速自動偵測

### 第二階段（功能增強）
1. ✅ 進度顯示與統計
2. ✅ 設定管理系統
3. ✅ 改進的錯誤處理
4. ✅ UI/UX 改進

### 第三階段（進階功能）
1. ⏳ 轉換中斷恢復
2. ⏳ 批次處理優化
3. ⏳ 測試覆蓋
4. ⏳ 效能調優

## 四、技術建議

### 4.1 依賴套件
```txt
opencv-python>=4.8.0
numpy>=1.24.0
```

### 4.2 FFmpeg 參數優化
- 使用 `-preset` 參數平衡速度與品質
- 使用 `-crf` 替代固定位元率（可選）
- 添加 `-movflags +faststart` 優化串流
- 使用 `-threads` 根據硬體調整

### 4.3 記憶體管理
- 使用生成器處理大型檔案列表
- 限制並發轉換數量
- 及時釋放 FFmpeg 程序資源

### 4.4 跨平台考量
- 路徑處理使用 `pathlib`
- 檢查 FFmpeg 可用性
- 處理不同平台的編碼器差異

## 五、預期效益

### 5.1 程式碼品質
- 減少程式碼重複 60%+
- 提高可維護性
- 易於擴展新功能

### 5.2 使用者體驗
- 清晰的進度回饋
- 更穩定的錯誤處理
- 更直觀的操作介面

### 5.3 效能
- 自動選擇最佳編碼器
- 更好的資源利用
- 減少轉換失敗率

## 六、風險與注意事項

### 6.1 相容性
- 確保 FFmpeg 版本相容性
- 處理不同硬體加速的差異
- 向後相容現有序列號檔案

### 6.2 資料安全
- 轉換前備份重要檔案（可選）
- 驗證輸出檔案完整性
- 提供取消轉換時的清理機制

### 6.3 效能影響
- UI 更新頻率控制（避免阻塞）
- 大量檔案時的記憶體管理
- 長時間運行的穩定性
